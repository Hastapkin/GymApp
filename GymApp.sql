-- =============================================
-- SCRIPT TแบO BแบขNG Vร Dแปฎ LIแปU MแบชU
-- Chแบกy vแปi user C##GymApp/a123
-- =============================================

-- Xรณa bแบฃng nแบฟu ฤรฃ tแปn tแบกi (ฤแป chแบกy lแบกi script)
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE MembershipCards CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Members CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Staff CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE Packages CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

-- =============================================
-- TแบO CรC BแบขNG
-- =============================================

-- Bแบฃng Members (Thรnh viรชn)
CREATE TABLE Members (
    Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    FullName NVARCHAR2(100) NOT NULL,
    Phone NVARCHAR2(20),
    Email NVARCHAR2(100),
    Gender NVARCHAR2(10) CHECK (Gender IN ('Nam', 'Nแปฏ', 'Khรกc')),
    DateOfBirth DATE,
    Address NVARCHAR2(200),
    JoinDate DATE DEFAULT SYSDATE,
    IsActive NUMBER(1) DEFAULT 1 CHECK (IsActive IN (0,1)),
    Notes NVARCHAR2(500),
    CreatedDate DATE DEFAULT SYSDATE,
    UpdatedDate DATE DEFAULT SYSDATE
);

-- Bแบฃng Packages (Gรณi tแบญp)
CREATE TABLE Packages (
    Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    PackageName NVARCHAR2(100) NOT NULL,
    Description NVARCHAR2(500),
    DurationDays NUMBER NOT NULL,
    Price NUMBER(10,2) NOT NULL,
    IsActive NUMBER(1) DEFAULT 1 CHECK (IsActive IN (0,1)),
    CreatedDate DATE DEFAULT SYSDATE
);

-- Bแบฃng MembershipCards (Thแบป tแบญp)
CREATE TABLE MembershipCards (
    Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    MemberId NUMBER NOT NULL,
    PackageId NUMBER NOT NULL,
    StartDate DATE NOT NULL,
    EndDate DATE NOT NULL,
    Price NUMBER(10,2) NOT NULL,
    PaymentMethod NVARCHAR2(50) DEFAULT 'Tiแปn mแบทt',
    Status NVARCHAR2(20) DEFAULT 'Hoแบกt ฤแปng' CHECK (Status IN ('Hoแบกt ฤแปng', 'Hแบฟt hแบกn', 'Tแบกm ngฦฐng')),
    Notes NVARCHAR2(500),
    CreatedDate DATE DEFAULT SYSDATE,
    CreatedBy NVARCHAR2(50) DEFAULT 'Admin',
    CONSTRAINT FK_MemberId FOREIGN KEY (MemberId) REFERENCES Members(Id) ON DELETE CASCADE,
    CONSTRAINT FK_PackageId FOREIGN KEY (PackageId) REFERENCES Packages(Id)
);

-- Bแบฃng Staff (Nhรขn viรชn)
CREATE TABLE Staff (
    Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    FullName NVARCHAR2(100) NOT NULL,
    Phone NVARCHAR2(20),
    Email NVARCHAR2(100),
    Role NVARCHAR2(50) NOT NULL CHECK (Role IN ('Lao cรดng', 'Thu ngรขn', 'Quแบฃn lรฝ', 'Huแบฅn luyแปn viรชn')),
    StartDate DATE DEFAULT SYSDATE,
    Salary NUMBER(10,2) DEFAULT 0,
    Address NVARCHAR2(200),
    IsActive NUMBER(1) DEFAULT 1 CHECK (IsActive IN (0,1)),
    Notes NVARCHAR2(500),
    CreatedDate DATE DEFAULT SYSDATE
);

-- Bแบฃng CheckInLog (Lแปch sแปญ check-in)
CREATE TABLE CheckInLog (
    Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    MemberId NUMBER NOT NULL,
    CheckInTime DATE DEFAULT SYSDATE,
    CheckOutTime DATE,
    Notes NVARCHAR2(200),
    CONSTRAINT FK_CheckIn_MemberId FOREIGN KEY (MemberId) REFERENCES Members(Id)
);

-- =============================================
-- TแบO INDEX
-- =============================================

-- Index cho tรฌm kiแบฟm nhanh
CREATE INDEX IDX_Members_FullName ON Members(FullName);
CREATE INDEX IDX_Members_Phone ON Members(Phone);
CREATE INDEX IDX_MembershipCards_MemberId ON MembershipCards(MemberId);
CREATE INDEX IDX_MembershipCards_EndDate ON MembershipCards(EndDate);
CREATE INDEX IDX_CheckInLog_MemberId ON CheckInLog(MemberId);
CREATE INDEX IDX_CheckInLog_CheckInTime ON CheckInLog(CheckInTime);

-- =============================================
-- THรM Dแปฎ LIแปU MแบชU
-- =============================================

-- Thรชm gรณi tแบญp mแบซu
INSERT INTO Packages (PackageName, Description, DurationDays, Price) VALUES 
('Gรณi 1 thรกng', 'Gรณi tแบญp cฦก bแบฃn 1 thรกng', 30, 500000);

INSERT INTO Packages (PackageName, Description, DurationDays, Price) VALUES 
('Gรณi 3 thรกng', 'Gรณi tแบญp 3 thรกng tiแบฟt kiแปm', 90, 1400000);

INSERT INTO Packages (PackageName, Description, DurationDays, Price) VALUES 
('Gรณi 6 thรกng', 'Gรณi tแบญp 6 thรกng ฦฐu ฤรฃi', 180, 2700000);

INSERT INTO Packages (PackageName, Description, DurationDays, Price) VALUES 
('Gรณi 1 nฤm', 'Gรณi tแบญp 1 nฤm VIP', 365, 5000000);

-- Thรชm nhรขn viรชn mแบซu
INSERT INTO Staff (FullName, Phone, Role, Salary, Address) VALUES 
('Nguyแปn Thแป Lan', '0987654321', 'Lao cรดng', 8000000, 'Hร Nแปi');

INSERT INTO Staff (FullName, Phone, Role, Salary, Address) VALUES 
('Trแบงn Vฤn Nam', '0123456789', 'Thu ngรขn', 12000000, 'Hร Nแปi');


-- Kiแปm tra dแปฏ liแปu
SELECT * FROM Members;
SELECT * FROM Staff;
SELECT * FROM Packages;
SELECT * FROM MembershipCards;
SELECT * FROM V_MemberInfo;

-- Oracle Identity columns cho tแบฅt cแบฃ tables
-- 1. Members table
ALTER TABLE Members MODIFY Id GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH LIMIT VALUE);

-- 2. Packages table  
ALTER TABLE Packages MODIFY Id GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH LIMIT VALUE);

-- 3. Staff table
ALTER TABLE Staff MODIFY Id GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH LIMIT VALUE);

-- 4. MembershipCards table
ALTER TABLE MembershipCards MODIFY Id GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH LIMIT VALUE);

-- Commit changes
COMMIT;


DROP VIEW V_MemberInfo;

-- Tแบกo view mแปi vแปi logic chรญnh xรกc:
-- Mแปi Member chแป hiแปn thแป thแบป tแบญp cรณ EndDate gแบงn nhแบฅt (thแบป hiแปn tแบกi)
CREATE VIEW V_MemberInfo AS
SELECT 
    m.Id,
    m.FullName,
    m.Phone,
    m.Email,
    m.Gender,
    m.JoinDate,
    
    -- Thรดng tin thแบป tแบญp hiแปn tแบกi (thแบป cรณ EndDate gแบงn nhแบฅt)
    mc.StartDate,
    mc.EndDate,
    p.PackageName,
    mc.Price,
    mc.Status,
    
    -- Tรญnh trแบกng thรกi thรnh viรชn dแปฑa trรชn thแบป hiแปn tแบกi
    CASE 
        WHEN mc.EndDate >= SYSDATE AND mc.Status = 'Hoแบกt ฤแปng' THEN 'Cรฒn hแบกn'
        WHEN mc.EndDate < SYSDATE OR mc.Status != 'Hoแบกt ฤแปng' THEN 'Hแบฟt hแบกn'
        ELSE 'Chฦฐa cรณ thแบป'
    END as MembershipStatus,
    
    -- Sแป ngรy cรฒn lแบกi (cรณ thแป รขm nแบฟu hแบฟt hแบกn)
    TRUNC(mc.EndDate - SYSDATE) as DaysRemaining
    
FROM Members m
LEFT JOIN (
    -- Subquery ฤแป lแบฅy thแบป tแบญp hiแปn tแบกi (EndDate gแบงn nhแบฅt) cแปงa mแปi member
    SELECT 
        mc1.MemberId,
        mc1.Id,
        mc1.PackageId,
        mc1.StartDate,
        mc1.EndDate,
        mc1.Price,
        mc1.Status
    FROM MembershipCards mc1
    WHERE mc1.EndDate = (
        -- Lแบฅy EndDate lแปn nhแบฅt cแปงa member ฤรณ
        SELECT MAX(mc2.EndDate)
        FROM MembershipCards mc2
        WHERE mc2.MemberId = mc1.MemberId
    )
) mc ON m.Id = mc.MemberId
LEFT JOIN Packages p ON mc.PackageId = p.Id
WHERE m.IsActive = 1;

-- ===================================================
-- 1. INSERT MEMBERS
-- ===================================================

-- Member 1: Lรช Minh Tuแบฅn
INSERT INTO Members (FullName, Phone, Email, Gender, DateOfBirth, Address, JoinDate, IsActive, Notes, CreatedDate, UpdatedDate)
VALUES (
    'Lรช Minh Tuแบฅn', 
    '0901234567', 
    'tuan@email.com', 
    'Nam', 
    DATE '1990-05-15', 
    'Cแบงu Giแบฅy, Hร Nแปi', 
    DATE '2025-01-15', 
    1, 
    'Thรnh viรชn VIP, quan tรขm ฤแบฟn cardio vร yoga',
    SYSDATE, 
    SYSDATE
);

-- Member 2: Phแบกm Thแป Hoa  
INSERT INTO Members (FullName, Phone, Email, Gender, DateOfBirth, Address, JoinDate, IsActive, Notes, CreatedDate, UpdatedDate)
VALUES (
    'Phแบกm Thแป Hoa', 
    '0912345678', 
    'hoa@email.com', 
    'Nแปฏ', 
    DATE '1995-08-20', 
    'Thanh Xuรขn, Hร Nแปi', 
    DATE '2025-02-01', 
    1, 
    'Thรญch tแบญp group fitness, ฤรฃ tham gia lแปp zumba',
    SYSDATE, 
    SYSDATE
);

-- Member 3: Hoรng Vฤn ฤแปฉc
INSERT INTO Members (FullName, Phone, Email, Gender, DateOfBirth, Address, JoinDate, IsActive, Notes, CreatedDate, UpdatedDate)
VALUES (
    'Hoรng Vฤn ฤแปฉc', 
    '0923456789', 
    'duc@email.com', 
    'Nam', 
    DATE '1988-12-10', 
    'ฤแปng ฤa, Hร Nแปi', 
    DATE '2025-01-01', 
    1, 
    'Bodybuilder, tแบญp trแปng lฦฐแปฃng nแบทng, cรณ kinh nghiแปm 5 nฤm',
    SYSDATE, 
    SYSDATE
);

-- Member 4: Nguyแปn Thแป Mai
INSERT INTO Members (FullName, Phone, Email, Gender, DateOfBirth, Address, JoinDate, IsActive, Notes, CreatedDate, UpdatedDate)
VALUES (
    'Nguyแปn Thแป Mai', 
    '0934567890', 
    'mai@email.com', 
    'Nแปฏ', 
    DATE '1992-03-25', 
    'Ba ฤรฌnh, Hร Nแปi', 
    DATE '2025-02-15', 
    1, 
    'Mแปi bแบฏt ฤแบงu tแบญp gym, cแบงn hฦฐแปng dแบซn cฦก bแบฃn',
    SYSDATE, 
    SYSDATE
);

-- Member 5: Vลฉ Minh Hแบฃi
INSERT INTO Members (FullName, Phone, Email, Gender, DateOfBirth, Address, JoinDate, IsActive, Notes, CreatedDate, UpdatedDate)
VALUES (
    'Vลฉ Minh Hแบฃi', 
    '0945678901', 
    'hai@email.com', 
    'Nam', 
    DATE '1985-07-08', 
    'Hoรn Kiแบฟm, Hร Nแปi', 
    DATE '2025-01-01', 
    1, 
    'Luyแปn tแบญp marathon, tแบญp trung vรo endurance training',
    SYSDATE, 
    SYSDATE
);

-- ===================================================
-- 2. INSERT MEMBERSHIP CARDS
-- ===================================================

-- Lแบฅy Member IDs
DECLARE
    v_member_id_1 NUMBER;
    v_member_id_2 NUMBER;
    v_member_id_3 NUMBER;
    v_member_id_4 NUMBER;
    v_member_id_5 NUMBER;
BEGIN
    -- Lแบฅy IDs cแปงa cรกc members vแปซa tแบกo
    SELECT Id INTO v_member_id_1 FROM Members WHERE FullName = 'Lรช Minh Tuแบฅn';
    SELECT Id INTO v_member_id_2 FROM Members WHERE FullName = 'Phแบกm Thแป Hoa';
    SELECT Id INTO v_member_id_3 FROM Members WHERE FullName = 'Hoรng Vฤn ฤแปฉc';
    SELECT Id INTO v_member_id_4 FROM Members WHERE FullName = 'Nguyแปn Thแป Mai';
    SELECT Id INTO v_member_id_5 FROM Members WHERE FullName = 'Vลฉ Minh Hแบฃi';

    -- Membership Card 1: Lรช Minh Tuแบฅn - Gรณi 3 thรกng
    INSERT INTO MembershipCards (MemberId, PackageId, StartDate, EndDate, Price, PaymentMethod, Status, Notes, CreatedDate, CreatedBy)
    VALUES (
        v_member_id_1, 
        2, -- Gรณi 3 thรกng (90 ngรy)
        DATE '2025-01-15', 
        DATE '2025-04-15', 
        1400000, 
        'Tiแปn mแบทt', 
        'Hoแบกt ฤแปng',
        'ฤฤng kรฝ gรณi 3 thรกng, thanh toรกn mแปt lแบงn',
        DATE '2025-01-15', 
        'Admin'
    );

    -- Membership Card 2: Phแบกm Thแป Hoa - Gรณi 1 thรกng  
    INSERT INTO MembershipCards (MemberId, PackageId, StartDate, EndDate, Price, PaymentMethod, Status, Notes, CreatedDate, CreatedBy)
    VALUES (
        v_member_id_2, 
        1, -- Gรณi 1 thรกng (30 ngรy)
        DATE '2025-02-01', 
        DATE '2025-03-03', -- 30 ngรy sau 01/02
        500000, 
        'Chuyแปn khoแบฃn', 
        'Hoแบกt ฤแปng',
        'Gรณi trแบฃi nghiแปm 1 thรกng, thรnh viรชn mแปi',
        DATE '2025-02-01', 
        'Admin'
    );

    -- Membership Card 3: Hoรng Vฤn ฤแปฉc - Gรณi 6 thรกng
    INSERT INTO MembershipCards (MemberId, PackageId, StartDate, EndDate, Price, PaymentMethod, Status, Notes, CreatedDate, CreatedBy)
    VALUES (
        v_member_id_3, 
        3, -- Gรณi 6 thรกng (180 ngรy)
        DATE '2025-01-01', 
        DATE '2025-07-01', -- 180 ngรy sau 01/01
        2700000, 
        'Tiแปn mแบทt', 
        'Hoแบกt ฤแปng',
        'Gรณi 6 thรกng cho bodybuilder, cรณ discount 5%',
        DATE '2025-01-01', 
        'Admin'
    );

    -- Membership Card 4: Nguyแปn Thแป Mai - Gรณi 1 thรกng
    INSERT INTO MembershipCards (MemberId, PackageId, StartDate, EndDate, Price, PaymentMethod, Status, Notes, CreatedDate, CreatedBy)
    VALUES (
        v_member_id_4, 
        1, -- Gรณi 1 thรกng (30 ngรy)
        DATE '2025-02-15', 
        DATE '2025-03-17', -- 30 ngรy sau 15/02
        500000, 
        'Tiแปn mแบทt', 
        'Hoแบกt ฤแปng',
        'Thรnh viรชn mแปi, gรณi khแปi ฤแปng',
        DATE '2025-02-15', 
        'Admin'
    );

    -- Membership Card 5: Vลฉ Minh Hแบฃi - Gรณi 1 nฤm VIP
    INSERT INTO MembershipCards (MemberId, PackageId, StartDate, EndDate, Price, PaymentMethod, Status, Notes, CreatedDate, CreatedBy)
    VALUES (
        v_member_id_5, 
        4, -- Gรณi 1 nฤm (365 ngรy)
        DATE '2025-01-01', 
        DATE '2025-12-31', -- 365 ngรy sau 01/01
        5000000, 
        'Chuyแปn khoแบฃn', 
        'Hoแบกt ฤแปng',
        'Gรณi VIP 1 nฤm, bao gแปm PT vร massage',
        DATE '2025-01-01', 
        'Admin'
    );

    DBMS_OUTPUT.PUT_LINE('=== ฤร TแบO 5 MEMBERS Vร MEMBERSHIP CARDS ===');
    DBMS_OUTPUT.PUT_LINE('1. Lรช Minh Tuแบฅn - Gรณi 3 thรกng (01/01 - 15/04)');
    DBMS_OUTPUT.PUT_LINE('2. Phแบกm Thแป Hoa - Gรณi 1 thรกng (01/02 - 03/03)');
    DBMS_OUTPUT.PUT_LINE('3. Hoรng Vฤn ฤแปฉc - Gรณi 6 thรกng (01/01 - 01/07)');
    DBMS_OUTPUT.PUT_LINE('4. Nguyแปn Thแป Mai - Gรณi 1 thรกng (15/02 - 17/03)');
    DBMS_OUTPUT.PUT_LINE('5. Vลฉ Minh Hแบฃi - Gรณi 1 nฤm VIP (01/01 - 31/12)');
END;
/

-- ===================================================
-- 3. VERIFY DATA - KIแปM TRA Dแปฎ LIแปU
-- ===================================================

-- Kiแปm tra Members
SELECT 
    Id,
    FullName,
    Phone,
    Email,
    Gender,
    TO_CHAR(DateOfBirth, 'DD/MM/YYYY') as DateOfBirth,
    TO_CHAR(JoinDate, 'DD/MM/YYYY') as JoinDate,
    CASE WHEN IsActive = 1 THEN 'Hoแบกt ฤแปng' ELSE 'Khรดng hoแบกt ฤแปng' END as Status
FROM Members 
WHERE FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')
ORDER BY Id;

-- Kiแปm tra Membership Cards
SELECT 
    mc.Id,
    m.FullName,
    p.PackageName,
    TO_CHAR(mc.StartDate, 'DD/MM/YYYY') as StartDate,
    TO_CHAR(mc.EndDate, 'DD/MM/YYYY') as EndDate,
    mc.Price,
    mc.PaymentMethod,
    mc.Status,
    TRUNC(mc.EndDate - SYSDATE) as DaysRemaining,
    CASE 
        WHEN mc.EndDate >= SYSDATE THEN 'Cรฒn hแบกn'
        ELSE 'Hแบฟt hแบกn'
    END as MembershipStatus
FROM MembershipCards mc
INNER JOIN Members m ON mc.MemberId = m.Id
INNER JOIN Packages p ON mc.PackageId = p.Id
WHERE m.FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')
ORDER BY mc.Id;

-- Kiแปm tra qua View V_MemberInfo
SELECT 
    Id,
    FullName,
    Phone,
    PackageName,
    TO_CHAR(StartDate, 'DD/MM/YYYY') as StartDate,
    TO_CHAR(EndDate, 'DD/MM/YYYY') as EndDate,
    Price,
    MembershipStatus,
    DaysRemaining,
    CASE 
        WHEN DaysRemaining > 30 THEN '๐ข Tแปt'
        WHEN DaysRemaining BETWEEN 8 AND 30 THEN '๐ก Bรฌnh thฦฐแปng'
        WHEN DaysRemaining BETWEEN 1 AND 7 THEN '๐ Cแบฃnh bรกo'
        WHEN DaysRemaining = 0 THEN '๐ด Hแบฟt hแบกn hรดm nay'
        ELSE 'โซ ฤรฃ hแบฟt hแบกn'
    END as Alert
FROM V_MemberInfo 
WHERE FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')
ORDER BY DaysRemaining DESC;

-- ===================================================
-- 4. SUMMARY STATISTICS
-- ===================================================

SELECT 
    'Tแปng thรnh viรชn' as Metric,
    COUNT(*) as Value
FROM Members 
WHERE FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')

UNION ALL

SELECT 
    'Tแปng thแบป tแบญp' as Metric,
    COUNT(*) as Value
FROM MembershipCards mc
INNER JOIN Members m ON mc.MemberId = m.Id
WHERE m.FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')

UNION ALL

SELECT 
    'Thแบป cรฒn hแบกn' as Metric,
    COUNT(*) as Value
FROM V_MemberInfo 
WHERE FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi')
AND MembershipStatus = 'Cรฒn hแบกn'

UNION ALL

SELECT 
    'Tแปng doanh thu' as Metric,
    SUM(Price) as Value
FROM V_MemberInfo 
WHERE FullName IN ('Lรช Minh Tuแบฅn', 'Phแบกm Thแป Hoa', 'Hoรng Vฤn ฤแปฉc', 'Nguyแปn Thแป Mai', 'Vลฉ Minh Hแบฃi');

COMMIT;